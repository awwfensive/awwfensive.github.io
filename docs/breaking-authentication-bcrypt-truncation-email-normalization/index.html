<!DOCTYPE html>
<html lang="en-US">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Breaking Authentication: Bcrypt Truncation &amp; Email Normalization | aniket/awwfensive</title>
<meta name="title" content="Breaking Authentication: Bcrypt Truncation &amp; Email Normalization" />
<meta name="description" content="
  
  
    Introduction
      
        Attack Chain Overview
      
    
    The Application
      
        Technology Stack
      
    
    Source Code Analysis
      
        User Registration Endpoint
      
    
    Vulnerability Analysis
      
        Vulnerability #1: Predictable Password Generation
        Vulnerability #2: Bcrypt&rsquo;s 72-Byte Truncation
        Vulnerability #3: Inconsistent Email Processing
        Vulnerability #4: Email Normalization Behavior
      
    
    Exploitation Strategy
      
        Attack Requirements
        Constructing the Payload
      
    
    Step-by-Step Exploitation
      
        Step 1: Crafting the Malicious Email
        Step 2: Registration
        Step 3: Authentication Bypass
        Step 4: Access Granted
      
    
    Impact Assessment
      
        Immediate Threats
        Attack Scalability
        Real-World Scenarios
      
    
    Root Cause Analysis
      
        1. Inconsistent Data Processing
        2. Misunderstanding Cryptographic Primitives
        3. User-Controlled Secret Components
        4. Incomplete Feature Implementation
      
    
    Remediation
      
        Fix #1: Consistent Email Processing
        Fix #2: Remove User Input from Password Generation
        Fix #3: Validate Before Bcrypt
        Fix #4: Implement Proper Password Delivery
        Fix #5: Add Comprehensive Input Validation
      
    
    Lessons Learned
      
        For Developers
        For Security Reviewers
      
    
    Conclusion
  


Introduction
During ImaginaryCTF 2025, I tackled a fascinating web challenge called &ldquo;passwordless&rdquo; that showcased how multiple subtle implementation flaws can combine to create a critical authentication bypass. The challenge presented a Node.js authentication system where users register with their email and receive a randomly generated temporary password—except the password delivery mechanism was never implemented." />
<meta name="keywords" content="" />


<meta property="og:url" content="//localhost:1313/breaking-authentication-bcrypt-truncation-email-normalization/">
  <meta property="og:site_name" content="aniket/awwfensive">
  <meta property="og:title" content="Breaking Authentication: Bcrypt Truncation & Email Normalization">
  <meta property="og:description" content="Introduction Attack Chain Overview The Application Technology Stack Source Code Analysis User Registration Endpoint Vulnerability Analysis Vulnerability #1: Predictable Password Generation Vulnerability #2: Bcrypt’s 72-Byte Truncation Vulnerability #3: Inconsistent Email Processing Vulnerability #4: Email Normalization Behavior Exploitation Strategy Attack Requirements Constructing the Payload Step-by-Step Exploitation Step 1: Crafting the Malicious Email Step 2: Registration Step 3: Authentication Bypass Step 4: Access Granted Impact Assessment Immediate Threats Attack Scalability Real-World Scenarios Root Cause Analysis 1. Inconsistent Data Processing 2. Misunderstanding Cryptographic Primitives 3. User-Controlled Secret Components 4. Incomplete Feature Implementation Remediation Fix #1: Consistent Email Processing Fix #2: Remove User Input from Password Generation Fix #3: Validate Before Bcrypt Fix #4: Implement Proper Password Delivery Fix #5: Add Comprehensive Input Validation Lessons Learned For Developers For Security Reviewers Conclusion Introduction During ImaginaryCTF 2025, I tackled a fascinating web challenge called “passwordless” that showcased how multiple subtle implementation flaws can combine to create a critical authentication bypass. The challenge presented a Node.js authentication system where users register with their email and receive a randomly generated temporary password—except the password delivery mechanism was never implemented.">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-10-25T11:51:55+05:30">
    <meta property="article:modified_time" content="2025-10-25T11:51:55+05:30">




  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Breaking Authentication: Bcrypt Truncation & Email Normalization">
  <meta name="twitter:description" content="Introduction Attack Chain Overview The Application Technology Stack Source Code Analysis User Registration Endpoint Vulnerability Analysis Vulnerability #1: Predictable Password Generation Vulnerability #2: Bcrypt’s 72-Byte Truncation Vulnerability #3: Inconsistent Email Processing Vulnerability #4: Email Normalization Behavior Exploitation Strategy Attack Requirements Constructing the Payload Step-by-Step Exploitation Step 1: Crafting the Malicious Email Step 2: Registration Step 3: Authentication Bypass Step 4: Access Granted Impact Assessment Immediate Threats Attack Scalability Real-World Scenarios Root Cause Analysis 1. Inconsistent Data Processing 2. Misunderstanding Cryptographic Primitives 3. User-Controlled Secret Components 4. Incomplete Feature Implementation Remediation Fix #1: Consistent Email Processing Fix #2: Remove User Input from Password Generation Fix #3: Validate Before Bcrypt Fix #4: Implement Proper Password Delivery Fix #5: Add Comprehensive Input Validation Lessons Learned For Developers For Security Reviewers Conclusion Introduction During ImaginaryCTF 2025, I tackled a fascinating web challenge called “passwordless” that showcased how multiple subtle implementation flaws can combine to create a critical authentication bypass. The challenge presented a Node.js authentication system where users register with their email and receive a randomly generated temporary password—except the password delivery mechanism was never implemented.">




  <meta itemprop="name" content="Breaking Authentication: Bcrypt Truncation & Email Normalization">
  <meta itemprop="description" content="Introduction Attack Chain Overview The Application Technology Stack Source Code Analysis User Registration Endpoint Vulnerability Analysis Vulnerability #1: Predictable Password Generation Vulnerability #2: Bcrypt’s 72-Byte Truncation Vulnerability #3: Inconsistent Email Processing Vulnerability #4: Email Normalization Behavior Exploitation Strategy Attack Requirements Constructing the Payload Step-by-Step Exploitation Step 1: Crafting the Malicious Email Step 2: Registration Step 3: Authentication Bypass Step 4: Access Granted Impact Assessment Immediate Threats Attack Scalability Real-World Scenarios Root Cause Analysis 1. Inconsistent Data Processing 2. Misunderstanding Cryptographic Primitives 3. User-Controlled Secret Components 4. Incomplete Feature Implementation Remediation Fix #1: Consistent Email Processing Fix #2: Remove User Input from Password Generation Fix #3: Validate Before Bcrypt Fix #4: Implement Proper Password Delivery Fix #5: Add Comprehensive Input Validation Lessons Learned For Developers For Security Reviewers Conclusion Introduction During ImaginaryCTF 2025, I tackled a fascinating web challenge called “passwordless” that showcased how multiple subtle implementation flaws can combine to create a critical authentication bypass. The challenge presented a Node.js authentication system where users register with their email and receive a randomly generated temporary password—except the password delivery mechanism was never implemented.">
  <meta itemprop="datePublished" content="2025-10-25T11:51:55+05:30">
  <meta itemprop="dateModified" content="2025-10-25T11:51:55+05:30">
  <meta itemprop="wordCount" content="2460">
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  :root {
    --width: 720px;
    --font-main: Verdana, sans-serif;
    --font-secondary: Verdana, sans-serif;
    --font-scale: 1em;
    --background-color: #fff;
    --heading-color: #222;
    --text-color: #444;
    --link-color: #3273dc;
    --visited-color: #8b6fcb;
    --blockquote-color: #222;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --background-color: #01242e;
      --heading-color: #eee;
      --text-color: #ddd;
      --link-color: #8cc2dd;
      --visited-color: #8b6fcb;
      --blockquote-color: #ccc;
    }
  }

  body {
    font-family: var(--font-secondary);
    font-size: var(--font-scale);
    margin: auto;
    padding: 20px;
    max-width: var(--width);
    text-align: left;
    background-color: var(--background-color);
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: var(--text-color);
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: var(--font-main);
    color: var(--heading-color);
  }

  a {
    color: var(--link-color);
    cursor: pointer;
    text-decoration: none;
  }

  a:hover {
    text-decoration: underline;
  }

  nav a {
    margin-right: 8px;
  }

  strong,
  b {
    color: var(--heading-color);
  }

  button {
    margin: 0;
    cursor: pointer;
  }

  time {
    font-family: monospace;
    font-style: normal;
    font-size: 15px;
  }

  main {
    line-height: 1.6;
  }

  table {
    width: 100%;
  }

  hr {
    border: 0;
    border-top: 1px dashed;
  }

  img {
    max-width: 100%;
  }

  code {
    font-family: monospace;
    padding: 2px;
    border-radius: 3px;
  }

  blockquote {
    border-left: 1px solid #999;
    color: var(--blockquote-color);
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px 0;
    text-align: center;
  }

  .title:hover {
    text-decoration: none;
  }

  .title h1 {
    font-size: 1.5em;
  }

  .inline {
    width: auto !important;
  }

  .highlight,
  .code {
    border-radius: 3px;
    margin-block-start: 1em;
    margin-block-end: 1em;
    overflow-x: auto;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 130px;
  }

  ul.blog-posts li a:visited {
    color: var(--visited-color);
  }

</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #ffffff;
    --text: #000000;
    --link: #8f0000;
  }
  
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #ffffff;
      --text: #000000;
      --link: #8f0000;
    }
  }
  
  body {
    background-color: white;
    color: #1a1a1a;
    font-family: 'Roboto Mono', monospace;
    line-height: 1.6;
    font-size: 1em;
    max-width: 720px;
    margin: 0 auto;
    padding: 20px;
  }
  
   
  h1, h2, h3, h4, h5, h6, p, li, span, div {
    color: #1a1a1a !important;
    font-family: 'Roboto Mono', monospace;
  }
  
   
  strong, b, em, i, mark {
    color: #1a1a1a !important;
  }
  
   
  h1 {
    font-size: 2em;
    line-height: 1.2;
  }
  
  h2 {
    font-size: 1.5em;
    margin-top: 2rem;
  }
  
  h3 {
    font-size: 1.2em;
    margin-top: 1.5rem;
  }
  
   
  header h1,
  header h1 a,
  header a.title,
  body > header > h1,
  body > header > h1 > a {
    color: #000000 !important;
    text-decoration: none !important;
    font-size: 1.1em;
    font-family: 'Roboto Mono', monospace;
  }
  
  header h1 a:hover {
    color: #000000 !important;
  }
  
   
  article h1,
  article h2,
  main h1,
  main h2 {
    color: #000000 !important;
  }
  
   
  a {
    color: #8f0000 !important;
    text-decoration: underline;
  }
  
  a:hover {
    color: #660000 !important;
  }
  
   
  header h1 a {
    text-decoration: none !important;
  }
  
   
  header nav a {
    margin-right: 1.5rem;
  }
  
   
  header {
    border-bottom: 1px solid #cccccc;
    padding-bottom: 1rem;
    margin-bottom: 2rem;
  }
  
   
  footer {
    border-top: none;
    padding-top: 1rem;
    margin-top: 3rem;
  }
  
   
  .blog-posts article {
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
  }
  
  .blog-posts article:last-child {
    border-bottom: none;
  }
  
   
 
.highlight {
  margin: 1.5rem 0;
}

.highlight pre {
  background-color: #f6f8fa !important;   
  padding: 1rem;
  border-radius: 4px;
  overflow-x: auto;
  line-height: 1.5;
  border: none;   
}

.highlight pre code,
.highlight code {
  background: transparent !important;
}

code {
  font-family: 'Roboto Mono', 'Courier New', monospace;
  font-size: 0.9em;
}

 
p code, li code, h1 code, h2 code, h3 code {
  background-color: #f6f8fa !important;
  color: #8f0000 !important;
  padding: 2px 6px;
  border-radius: 3px;
}

 
.highlight .c { color: #008000 !important; font-style: italic; }  
.highlight .err { color: #ff0000 !important; }  
.highlight .k { color: #0000ff !important; }  
.highlight .o { color: #000000 !important; }  
.highlight .cm { color: #008000 !important; font-style: italic; }  
.highlight .cp { color: #0000ff !important; }  
.highlight .c1 { color: #008000 !important; font-style: italic; }  
.highlight .cs { color: #008000 !important; font-style: italic; }  
.highlight .gd { color: #ff0000 !important; }  
.highlight .ge { font-style: italic; }  
.highlight .gr { color: #ff0000 !important; }  
.highlight .gh { color: #000080 !important; font-weight: bold; }  
.highlight .gi { color: #00ff00 !important; }  
.highlight .go { color: #808080 !important; }  
.highlight .gp { color: #808080 !important; }  
.highlight .gs { font-weight: bold; }  
.highlight .gu { color: #800080 !important; font-weight: bold; }  
.highlight .gt { color: #ff0000 !important; }  
.highlight .kc { color: #0000ff !important; }  
.highlight .kd { color: #0000ff !important; }  
.highlight .kn { color: #0000ff !important; }  
.highlight .kp { color: #0000ff !important; }  
.highlight .kr { color: #0000ff !important; }  
.highlight .kt { color: #0000ff !important; }  
.highlight .m { color: #098658 !important; }  
.highlight .s { color: #a31515 !important; }  
.highlight .na { color: #ff0000 !important; }  
.highlight .nb { color: #0000ff !important; }  
.highlight .nc { color: #267f99 !important; }  
.highlight .no { color: #0000ff !important; }  
.highlight .nd { color: #267f99 !important; }  
.highlight .ni { color: #0000ff !important; }  
.highlight .ne { color: #267f99 !important; }  
.highlight .nf { color: #795e26 !important; }  
.highlight .nl { color: #0000ff !important; }  
.highlight .nn { color: #267f99 !important; }  
.highlight .nt { color: #800000 !important; }  
.highlight .nv { color: #001080 !important; }  
.highlight .ow { color: #0000ff !important; }  
.highlight .w { color: #000000 !important; }  
.highlight .mb { color: #098658 !important; }  
.highlight .mf { color: #098658 !important; }  
.highlight .mh { color: #098658 !important; }  
.highlight .mi { color: #098658 !important; }  
.highlight .mo { color: #098658 !important; }  
.highlight .sa { color: #a31515 !important; }  
.highlight .sb { color: #a31515 !important; }  
.highlight .sc { color: #a31515 !important; }  
.highlight .dl { color: #a31515 !important; }  
.highlight .sd { color: #008000 !important; font-style: italic; }  
.highlight .s2 { color: #a31515 !important; }  
.highlight .se { color: #ee0000 !important; }  
.highlight .sh { color: #a31515 !important; }  
.highlight .si { color: #a31515 !important; }  
.highlight .sx { color: #a31515 !important; }  
.highlight .sr { color: #d16969 !important; }  
.highlight .s1 { color: #a31515 !important; }  
.highlight .ss { color: #a31515 !important; }  
.highlight .bp { color: #0000ff !important; }  
.highlight .fm { color: #795e26 !important; }  
.highlight .vc { color: #001080 !important; }  
.highlight .vg { color: #001080 !important; }  
.highlight .vi { color: #001080 !important; }  
.highlight .vm { color: #001080 !important; }  
.highlight .il { color: #098658 !important; }  
  
 
#TableOfContents {
  background-color: transparent;
  border: none;
  padding: 0;
  margin: 2rem 0;
  border-radius: 0;
}

 
#TableOfContents {
  background-color: transparent;
  border: none;
  padding: 0;
  margin: 2rem 0;
  border-radius: 0;
}

#TableOfContents ul {
  list-style: disc;
  padding-left: 2rem;
  margin: 0.5rem 0;
}

#TableOfContents > ul {
  padding-left: 2rem;
}

#TableOfContents ul ul {
  list-style: circle;
  padding-left: 2rem;
}

#TableOfContents li {
  margin: 0.5rem 0;
}

#TableOfContents a {
  color: #8f0000 !important;
  text-decoration: underline !important;
}

#TableOfContents a:hover {
  color: #660000 !important;
}

 

   
table {
  width: 100%;
  border-collapse: collapse;
  margin: 1.5rem 0;
  background-color: white;
}

table th,
table td {
  padding: 0.75rem;
  text-align: left;
  border: 1px solid #e1e4e8;
}

table th {
  background-color: #f6f8fa;
  font-weight: bold;
}

table code {
  background-color: #f6f8fa;
  padding: 2px 6px;
  border-radius: 3px;
  color: #24292e;
}
</style></head>

<body>
  <header><a href="/" class="title">
  <h2>aniket/awwfensive</h2>
</a>
<nav>
<a href="/">Home</a>

<a href="/blog/">Blog</a>

<a href="/projects/">Projects</a>

</nav>
</header>
  <main>

<h1>Breaking Authentication: Bcrypt Truncation &amp; Email Normalization</h1>
<p>
  <i>
    <time datetime='2025-10-25'>
      25 Oct, 2025
    </time>
  </i>
</p>

<content>
  <div class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#attack-chain-overview">Attack Chain Overview</a></li>
      </ul>
    </li>
    <li><a href="#the-application">The Application</a>
      <ul>
        <li><a href="#technology-stack">Technology Stack</a></li>
      </ul>
    </li>
    <li><a href="#source-code-analysis">Source Code Analysis</a>
      <ul>
        <li><a href="#user-registration-endpoint">User Registration Endpoint</a></li>
      </ul>
    </li>
    <li><a href="#vulnerability-analysis">Vulnerability Analysis</a>
      <ul>
        <li><a href="#vulnerability-1-predictable-password-generation">Vulnerability #1: Predictable Password Generation</a></li>
        <li><a href="#vulnerability-2-bcrypts-72-byte-truncation">Vulnerability #2: Bcrypt&rsquo;s 72-Byte Truncation</a></li>
        <li><a href="#vulnerability-3-inconsistent-email-processing">Vulnerability #3: Inconsistent Email Processing</a></li>
        <li><a href="#vulnerability-4-email-normalization-behavior">Vulnerability #4: Email Normalization Behavior</a></li>
      </ul>
    </li>
    <li><a href="#exploitation-strategy">Exploitation Strategy</a>
      <ul>
        <li><a href="#attack-requirements">Attack Requirements</a></li>
        <li><a href="#constructing-the-payload">Constructing the Payload</a></li>
      </ul>
    </li>
    <li><a href="#step-by-step-exploitation">Step-by-Step Exploitation</a>
      <ul>
        <li><a href="#step-1-crafting-the-malicious-email">Step 1: Crafting the Malicious Email</a></li>
        <li><a href="#step-2-registration">Step 2: Registration</a></li>
        <li><a href="#step-3-authentication-bypass">Step 3: Authentication Bypass</a></li>
        <li><a href="#step-4-access-granted">Step 4: Access Granted</a></li>
      </ul>
    </li>
    <li><a href="#impact-assessment">Impact Assessment</a>
      <ul>
        <li><a href="#immediate-threats">Immediate Threats</a></li>
        <li><a href="#attack-scalability">Attack Scalability</a></li>
        <li><a href="#real-world-scenarios">Real-World Scenarios</a></li>
      </ul>
    </li>
    <li><a href="#root-cause-analysis">Root Cause Analysis</a>
      <ul>
        <li><a href="#1-inconsistent-data-processing">1. Inconsistent Data Processing</a></li>
        <li><a href="#2-misunderstanding-cryptographic-primitives">2. Misunderstanding Cryptographic Primitives</a></li>
        <li><a href="#3-user-controlled-secret-components">3. User-Controlled Secret Components</a></li>
        <li><a href="#4-incomplete-feature-implementation">4. Incomplete Feature Implementation</a></li>
      </ul>
    </li>
    <li><a href="#remediation">Remediation</a>
      <ul>
        <li><a href="#fix-1-consistent-email-processing">Fix #1: Consistent Email Processing</a></li>
        <li><a href="#fix-2-remove-user-input-from-password-generation">Fix #2: Remove User Input from Password Generation</a></li>
        <li><a href="#fix-3-validate-before-bcrypt">Fix #3: Validate Before Bcrypt</a></li>
        <li><a href="#fix-4-implement-proper-password-delivery">Fix #4: Implement Proper Password Delivery</a></li>
        <li><a href="#fix-5-add-comprehensive-input-validation">Fix #5: Add Comprehensive Input Validation</a></li>
      </ul>
    </li>
    <li><a href="#lessons-learned">Lessons Learned</a>
      <ul>
        <li><a href="#for-developers">For Developers</a></li>
        <li><a href="#for-security-reviewers">For Security Reviewers</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
</div>
<h2 id="introduction">Introduction</h2>
<p>During ImaginaryCTF 2025, I tackled a fascinating web challenge called &ldquo;passwordless&rdquo; that showcased how multiple subtle implementation flaws can combine to create a critical authentication bypass. The challenge presented a Node.js authentication system where users register with their email and receive a randomly generated temporary password—except the password delivery mechanism was never implemented.</p>
<p>What made this challenge particularly interesting is that every security component appeared properly implemented at first glance: bcrypt for password hashing, email normalization to prevent duplicates, input validation, and rate limiting. However, the devil was in the details. The interaction between bcrypt&rsquo;s 72-byte truncation limit, inconsistent email processing, and user-controlled password components created a perfect exploit chain allowing complete authentication bypass.</p>
<h3 id="attack-chain-overview">Attack Chain Overview</h3>
<p><strong>→</strong> Identify password generation uses raw email + random hex</p>
<p><strong>→</strong> Discover bcrypt truncates passwords at 72 bytes</p>
<p><strong>→</strong> Find inconsistent email normalization between validation and password generation</p>
<p><strong>→</strong> Craft 72-byte email that normalizes to &lt;64 chars</p>
<p><strong>→</strong> Register account bypassing length validation</p>
<p><strong>→</strong> Login using email as password (random portion ignored by bcrypt)</p>
<hr>
<h2 id="the-application">The Application</h2>
<p>The target was a straightforward Express.js application with user registration and login functionality. The system was designed to send users a temporary password via email upon registration, though this feature remained unimplemented at the time of discovery.</p>
<p><strong>Key Features:</strong></p>
<ul>
<li>Email-based registration with auto-generated temporary passwords</li>
<li>Bcrypt password hashing for secure storage</li>
<li>Email normalization to prevent duplicate accounts</li>
<li>Rate limiting on authentication endpoints</li>
<li>Session-based authentication after login</li>
</ul>
<h3 id="technology-stack">Technology Stack</h3>
<ul>
<li><strong>Runtime:</strong> Node.js with Express.js framework</li>
<li><strong>Database:</strong> SQLite3 with in-memory storage</li>
<li><strong>Password Hashing:</strong> bcrypt (10 rounds)</li>
<li><strong>Email Processing:</strong> normalize-email npm package</li>
<li><strong>Session Management:</strong> express-session with MemoryStore</li>
</ul>
<hr>
<h2 id="source-code-analysis">Source Code Analysis</h2>
<p>Let&rsquo;s examine the vulnerable registration endpoint in detail. The code appears straightforward but contains subtle flaws that become apparent under scrutiny.</p>
<h3 id="user-registration-endpoint">User Registration Endpoint</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">,</span> <span class="nx">limiter</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">nEmail</span> <span class="o">=</span> <span class="nx">normalizeEmail</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">nEmail</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;Your email address is too long&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">initialPassword</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="o">+</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">initialPassword</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="s2">&#34;INSERT INTO users VALUES (?, ?)&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="p">[</span><span class="nx">nEmail</span><span class="p">,</span> <span class="nx">hash</span><span class="p">],</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">&#39;SQLITE_CONSTRAINT&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;This email address is already registered&#39;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// TODO: Send email with initial password
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;An email has been sent with a temporary password for you to log in&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><hr>
<h2 id="vulnerability-analysis">Vulnerability Analysis</h2>
<h3 id="vulnerability-1-predictable-password-generation">Vulnerability #1: Predictable Password Generation</h3>
<p>The application generates temporary passwords using a combination of the user&rsquo;s email and random bytes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">initialPassword</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="o">+</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>This creates a password with the following structure:</p>
<p><strong>Password Format:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">[</span><span class="n">user_email_address</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">32</span><span class="n">_hexadecimal_characters</span><span class="p">]</span>
</span></span></code></pre></div><p><strong>Example:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">counter</span><span class="err">@</span><span class="n">strike</span><span class="p">.</span><span class="n">com</span> <span class="o">+</span> <span class="n">a3f9b7d1e84c6f2a5c3d7e98f0a123bc</span>
</span></span><span class="line"><span class="cl"><span class="nl">Result</span><span class="p">:</span> <span class="n">counter</span><span class="err">@</span><span class="n">strike</span><span class="p">.</span><span class="n">coma3f9b7d1e84c6f2a5c3d7e98f0a123bc</span>
</span></span></code></pre></div><p>While the random component appears to provide security, this design has a critical flaw: it includes user-controlled data (the email address) as part of the password. Since users control the length of their email, they can influence what portion of the password bcrypt actually processes.</p>
<h3 id="vulnerability-2-bcrypts-72-byte-truncation">Vulnerability #2: Bcrypt&rsquo;s 72-Byte Truncation</h3>
<p>Bcrypt has a well-documented limitation that&rsquo;s often overlooked: it only processes the first 72 bytes of input and silently discards everything beyond that point. This isn&rsquo;t a bug—it&rsquo;s a fundamental characteristic of bcrypt&rsquo;s design.</p>
<p><strong>Security Impact:</strong> If an attacker can create an email address that&rsquo;s exactly 72 bytes long, the random hexadecimal suffix will be completely ignored by bcrypt. This effectively makes the password equal to the email address itself, since bcrypt never sees the random portion.</p>
<h4 id="how-bcrypt-processes-our-password">How Bcrypt Processes Our Password</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Password with short email (20 bytes)
</span></span></span><span class="line"><span class="cl"><span class="nx">Input</span><span class="o">:</span>     <span class="s2">&#34;user@example.com&#34;</span> <span class="o">+</span> <span class="s2">&#34;a3f9b7d1e84c6f2a5c3d7e98f0a123bc&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="p">[</span><span class="o">----------------</span><span class="p">]</span> <span class="p">[</span><span class="o">------------------------------</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">           <span class="mi">20</span> <span class="nx">bytes</span> <span class="nx">email</span>     <span class="mi">32</span> <span class="nx">bytes</span> <span class="nx">random</span> <span class="nx">hex</span>
</span></span><span class="line"><span class="cl"><span class="nx">Total</span><span class="o">:</span>     <span class="mi">52</span> <span class="nx">bytes</span>
</span></span><span class="line"><span class="cl"><span class="nx">Bcrypt</span><span class="o">:</span>    <span class="nx">Hashes</span> <span class="nx">all</span> <span class="mi">52</span> <span class="nx">bytes</span> <span class="p">(</span><span class="nx">random</span> <span class="nx">portion</span> <span class="nx">IS</span> <span class="nx">used</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Password with 72-byte email (attack scenario)
</span></span></span><span class="line"><span class="cl"><span class="nx">Input</span><span class="o">:</span>     <span class="s2">&#34;cs...[70 dots]...2@gmail.com&#34;</span> <span class="o">+</span> <span class="s2">&#34;a3f9b7d1e84c6f2a5c3d7e98f0a123bc&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="p">[</span><span class="o">---------------------------</span><span class="p">]</span> <span class="p">[</span><span class="o">------------------------------</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">           <span class="mi">72</span> <span class="nx">bytes</span> <span class="nx">email</span>                <span class="mi">32</span> <span class="nx">bytes</span> <span class="nx">random</span> <span class="nx">hex</span>
</span></span><span class="line"><span class="cl"><span class="nx">Total</span><span class="o">:</span>     <span class="mi">104</span> <span class="nx">bytes</span>
</span></span><span class="line"><span class="cl"><span class="nx">Bcrypt</span><span class="o">:</span>    <span class="nx">Hashes</span> <span class="nx">only</span> <span class="nx">first</span> <span class="mi">72</span> <span class="nx">bytes</span> <span class="p">(</span><span class="nx">random</span> <span class="nx">portion</span> <span class="nx">IGNORED</span><span class="o">!</span><span class="p">)</span>
</span></span></code></pre></div><p>In the attack scenario, bcrypt only sees the email portion. The 32 random characters are silently truncated, making the password predictable and equal to the email address.</p>
<h3 id="vulnerability-3-inconsistent-email-processing">Vulnerability #3: Inconsistent Email Processing</h3>
<p>The critical vulnerability lies in how the application processes emails differently at different stages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Stage 1: Length validation
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">nEmail</span> <span class="o">=</span> <span class="nx">normalizeEmail</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span>  <span class="c1">// ← Uses normalized email
</span></span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">nEmail</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Reject if too long
</span></span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Stage 2: Password generation
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">initialPassword</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="o">+</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>  <span class="c1">// ← Uses raw email!
</span></span></span></code></pre></div><p><strong>The Vulnerability:</strong> Length validation checks the normalized email, but password generation uses the raw email from the request body. This inconsistency creates a bypass opportunity.</p>
<h4 id="why-this-matters">Why This Matters</h4>
<p>If we can craft an email that:</p>
<ol>
<li>Normalizes to ≤64 characters (passes validation)</li>
<li>Is exactly 72 bytes in raw form (triggers bcrypt truncation)</li>
</ol>
<p>Then we can bypass both the length check AND make the password predictable!</p>
<h3 id="vulnerability-4-email-normalization-behavior">Vulnerability #4: Email Normalization Behavior</h3>
<p>The <code>normalize-email</code> library removes dots and plus signs from Gmail addresses as part of its normalization process. This is intended to prevent users from creating multiple accounts with variations of the same email.</p>
<h4 id="normalization-examples">Normalization Examples</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Dot removal
</span></span></span><span class="line"><span class="cl"><span class="nx">Input</span><span class="o">:</span>  <span class="s2">&#34;user.name@gmail.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">Output</span><span class="o">:</span> <span class="s2">&#34;username@gmail.com&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Multiple dots
</span></span></span><span class="line"><span class="cl"><span class="nx">Input</span><span class="o">:</span>  <span class="s2">&#34;u.s.e.r@gmail.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">Output</span><span class="o">:</span> <span class="s2">&#34;user@gmail.com&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Plus addressing removal
</span></span></span><span class="line"><span class="cl"><span class="nx">Input</span><span class="o">:</span>  <span class="s2">&#34;user+tag123@gmail.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">Output</span><span class="o">:</span> <span class="s2">&#34;user@gmail.com&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Combined
</span></span></span><span class="line"><span class="cl"><span class="nx">Input</span><span class="o">:</span>  <span class="s2">&#34;u.s.e.r+testing@gmail.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">Output</span><span class="o">:</span> <span class="s2">&#34;user@gmail.com&#34;</span>
</span></span></code></pre></div><p><strong>Attack Opportunity:</strong> We can use dots to artificially inflate the raw email length while keeping the normalized version short. For example, an email with 100 dots will normalize to a much shorter string, but the raw input remains long.</p>
<hr>
<h2 id="exploitation-strategy">Exploitation Strategy</h2>
<p>Now that we understand all the vulnerabilities, let&rsquo;s develop our attack strategy. We need to create an email that satisfies these precise constraints:</p>
<h3 id="attack-requirements">Attack Requirements</h3>
<p><strong>→</strong> Raw email must be exactly 72 bytes</p>
<p><strong>→</strong> Normalized email must be ≤64 characters</p>
<p><strong>→</strong> Must be a valid email format</p>
<p><strong>→</strong> Must work with Gmail normalization rules</p>
<h3 id="constructing-the-payload">Constructing the Payload</h3>
<p>The key insight is to use dots in a Gmail address. Let&rsquo;s work through the math:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Base Gmail address
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;cs2@gmail.com&#34;</span>  <span class="c1">// 14 bytes when normalized
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// We need 72 bytes total in raw form
</span></span></span><span class="line"><span class="cl"><span class="c1">// Domain portion: &#34;@gmail.com&#34; = 10 bytes
</span></span></span><span class="line"><span class="cl"><span class="c1">// Remaining space: 72 - 10 = 62 bytes for local part
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// We already have &#34;cs&#34; and &#34;2&#34; = 3 characters
</span></span></span><span class="line"><span class="cl"><span class="c1">// Need: 62 - 3 = 59 more characters (use dots)
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Final payload structure:
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;cs&#34;</span> <span class="o">+</span> <span class="p">[</span><span class="mi">59</span> <span class="nx">dots</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34;2@gmail.com&#34;</span>
</span></span></code></pre></div><h4 id="payload-verification">Payload Verification</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Raw</span> <span class="nl">Email</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">cs</span><span class="p">....................................................................................................................................................</span><span class="mf">.2</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="nf">com</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">72</span> <span class="n">bytes</span> <span class="n">total</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Normalized</span> <span class="nl">Email</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">cs2</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="nf">com</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="mi">13</span> <span class="n">bytes</span> <span class="o">-</span> <span class="n">well</span> <span class="n">under</span> <span class="mi">64</span> <span class="n">limit</span><span class="o">!</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Password</span> <span class="nl">Construction</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">initialPassword</span> <span class="o">=</span> <span class="s">&#34;cs...[59 dots]...2@gmail.com&#34;</span> <span class="o">+</span> <span class="s">&#34;a3f9b7d1e84c6f2a5c3d7e98f0a123bc&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">[</span><span class="o">-----------------------------</span><span class="p">]</span>   <span class="p">[</span><span class="o">------------------------------</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                  <span class="mi">72</span> <span class="nf">bytes</span> <span class="p">(</span><span class="n">all</span> <span class="n">bcrypt</span> <span class="n">sees</span><span class="p">)</span>        <span class="mi">32</span> <span class="nf">bytes</span> <span class="p">(</span><span class="n">ignored</span> <span class="n">by</span> <span class="n">bcrypt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Effective</span> <span class="nl">Password</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">cs</span><span class="p">....................................................................................................................................................</span><span class="mf">.2</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="nf">com</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">Just</span> <span class="n">the</span> <span class="n">email</span> <span class="o">-</span> <span class="n">random</span> <span class="n">portion</span> <span class="n">never</span> <span class="n">hashed</span><span class="o">!</span><span class="p">)</span>
</span></span></code></pre></div><hr>
<h2 id="step-by-step-exploitation">Step-by-Step Exploitation</h2>
<h3 id="step-1-crafting-the-malicious-email">Step 1: Crafting the Malicious Email</h3>
<p>First, let&rsquo;s create our precisely crafted email address with exactly 72 bytes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">cs</span><span class="p">....................................................................................................................................................</span><span class="mf">.2</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span>
</span></span></code></pre></div><p><strong>Important:</strong> Count carefully! The email must be exactly 72 bytes. Too few and the random portion will be partially included; too many and the validation check might fail depending on how dots are counted.</p>
<h3 id="step-2-registration">Step 2: Registration</h3>
<p>Navigate to the registration page and enter the crafted email in the registration form. When submitting:</p>
<ol>
<li>The application receives the raw 72-byte email</li>
<li>It normalizes the email to <code>cs2@gmail.com</code> (13 bytes)</li>
<li>The length check passes (13 ≤ 64)</li>
<li>Password is generated: 72-byte email + 32 hex chars = 104 bytes</li>
<li>Bcrypt hashes only first 72 bytes (just the email)</li>
<li>Database stores the normalized email with the truncated hash</li>
</ol>
<p><strong>Registration Success:</strong> The application accepts our registration and displays a message about sending an email with temporary password. Of course, no email is actually sent since that feature isn&rsquo;t implemented.</p>
<h3 id="step-3-authentication-bypass">Step 3: Authentication Bypass</h3>
<p>Now comes the moment of truth. Navigate to the login page and enter:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nl">Email</span><span class="p">:</span>    <span class="n">cs</span><span class="p">....................................................................................................................................................</span><span class="mf">.2</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span>
</span></span><span class="line"><span class="cl"><span class="nl">Password</span><span class="p">:</span> <span class="n">cs</span><span class="p">....................................................................................................................................................</span><span class="mf">.2</span><span class="err">@</span><span class="n">gmail</span><span class="p">.</span><span class="n">com</span>
</span></span></code></pre></div><p>Here&rsquo;s what happens during authentication:</p>
<ol>
<li>Application normalizes login email to <code>cs2@gmail.com</code></li>
<li>Retrieves stored password hash from database</li>
<li>Uses bcrypt to compare entered password with stored hash</li>
<li>Bcrypt truncates our 72-byte password input at 72 bytes (which is the full email)</li>
<li>This matches the hash stored during registration (which was also just the 72-byte email)</li>
<li>Authentication succeeds!</li>
</ol>
<h4 id="authentication-flow">Authentication Flow</h4>
<p><strong>→</strong> User enters 72-byte email as password</p>
<p><strong>→</strong> Bcrypt truncates at 72 bytes (entire email, no random data)</p>
<p><strong>→</strong> Compares with stored hash (also just the 72-byte email)</p>
<p><strong>→</strong> Match! User authenticated successfully</p>
<h3 id="step-4-access-granted">Step 4: Access Granted</h3>
<p>Upon successful authentication, the application creates a session and redirects to the dashboard. We&rsquo;ve successfully bypassed the authentication system with predictable credentials!</p>
<p><strong>Attack Success:</strong> We can now access the authenticated area of the application using credentials we controlled from the beginning. The &ldquo;random&rdquo; password was completely ineffective due to bcrypt truncation.</p>
<hr>
<h2 id="impact-assessment">Impact Assessment</h2>
<p>This vulnerability chain has severe security implications for any production system:</p>
<h3 id="immediate-threats">Immediate Threats</h3>
<ul>
<li><strong>Complete Authentication Bypass:</strong> Attackers can register and immediately access accounts without needing the temporary password</li>
<li><strong>No Dependency on Email Delivery:</strong> The attack works regardless of whether email functionality is implemented</li>
<li><strong>Predictable Credentials:</strong> Anyone who registers using this technique knows their own password</li>
<li><strong>Session Hijacking Potential:</strong> Once authenticated, attackers have full session access</li>
</ul>
<h3 id="attack-scalability">Attack Scalability</h3>
<p><strong>Mass Registration Risk:</strong> An attacker could register thousands of accounts using variations of this technique, all with predictable passwords. Rate limiting on the registration endpoint provides limited protection since each registration is &ldquo;legitimate&rdquo; from the application&rsquo;s perspective.</p>
<h3 id="real-world-scenarios">Real-World Scenarios</h3>
<ol>
<li><strong>Data Theft:</strong> Attacker creates accounts to access sensitive information or services</li>
<li><strong>Platform Abuse:</strong> Automated bot accounts for spam, scraping, or manipulation</li>
<li><strong>Resource Exhaustion:</strong> Creating numerous accounts to exhaust system resources</li>
<li><strong>Reputation Damage:</strong> Public disclosure of such a vulnerability seriously damages trust</li>
</ol>
<hr>
<h2 id="root-cause-analysis">Root Cause Analysis</h2>
<p>Let&rsquo;s examine the fundamental design flaws that enabled this vulnerability:</p>
<h3 id="1-inconsistent-data-processing">1. Inconsistent Data Processing</h3>
<p>The most critical error was applying different transformations to the same input at different stages:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Validation stage
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">nEmail</span> <span class="o">=</span> <span class="nx">normalizeEmail</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span>  <span class="c1">// Transformed
</span></span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">nEmail</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Password generation stage
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">initialPassword</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="o">+</span> <span class="p">...</span>   <span class="c1">// Raw, untransformed
</span></span></span></code></pre></div><p><strong>Principle Violated:</strong> When applying security controls, always use the same version of data throughout the process. If you validate normalized data, generate cryptographic material from normalized data too.</p>
<h3 id="2-misunderstanding-cryptographic-primitives">2. Misunderstanding Cryptographic Primitives</h3>
<p>The developers didn&rsquo;t account for bcrypt&rsquo;s 72-byte truncation behavior when designing the password generation logic. This is a well-documented characteristic that should influence implementation decisions.</p>
<h3 id="3-user-controlled-secret-components">3. User-Controlled Secret Components</h3>
<p>Including user input (email address) in generated passwords is fundamentally problematic:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Bad: User controls part of the &#34;random&#34; password
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">initialPassword</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span> <span class="o">+</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Good: Password is entirely random
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">initialPassword</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">32</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="4-incomplete-feature-implementation">4. Incomplete Feature Implementation</h3>
<p>The commented-out email functionality (<code>// TODO: Send email with initial password</code>) was a red flag that this registration flow wasn&rsquo;t production-ready. The security model depended on users not knowing their temporary password, but without email delivery, this assumption was already broken.</p>
<hr>
<h2 id="remediation">Remediation</h2>
<p>Here&rsquo;s how to properly fix these vulnerabilities and prevent similar issues in the future.</p>
<h3 id="fix-1-consistent-email-processing">Fix #1: Consistent Email Processing</h3>
<p>Always normalize email addresses immediately upon receipt and use the normalized version everywhere:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">,</span> <span class="nx">limiter</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Normalize once, use everywhere
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">normalizeEmail</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Validate BOTH normalized and raw lengths
</span></span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">email</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">72</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;Your email address is too long&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Use normalized email for password generation
</span></span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">initialPassword</span> <span class="o">=</span> <span class="nx">email</span> <span class="o">+</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Rest of implementation...
</span></span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><h3 id="fix-2-remove-user-input-from-password-generation">Fix #2: Remove User Input from Password Generation</h3>
<p>Generate completely random passwords without any user-controlled components:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Generate 32 random bytes = 64 hex characters
</span></span></span><span class="line"><span class="cl"><span class="c1">// Well within bcrypt&#39;s 72-byte limit with safety margin
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">initialPassword</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">32</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="fix-3-validate-before-bcrypt">Fix #3: Validate Before Bcrypt</h3>
<p>Add an explicit check to prevent passwords from exceeding bcrypt&rsquo;s limit:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">initialPassword</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">32</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Verify we&#39;re within bcrypt&#39;s limits
</span></span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">(</span><span class="nx">initialPassword</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">72</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Generated password exceeds bcrypt maximum length&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">bcrypt</span><span class="p">.</span><span class="nx">hash</span><span class="p">(</span><span class="nx">initialPassword</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">hash</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... rest of implementation
</span></span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><h3 id="fix-4-implement-proper-password-delivery">Fix #4: Implement Proper Password Delivery</h3>
<p>Complete the email functionality or implement a more secure registration flow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// Option 1: Send password via email
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">transporter</span> <span class="o">=</span> <span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">to</span><span class="o">:</span> <span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">subject</span><span class="o">:</span> <span class="s1">&#39;Your temporary password&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">text</span><span class="o">:</span> <span class="sb">`Your temporary password is: </span><span class="si">${</span><span class="nx">initialPassword</span><span class="si">}</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Option 2: Use password reset flow instead
</span></span></span><span class="line"><span class="cl"><span class="c1">// Generate a one-time token, email it to user
</span></span></span><span class="line"><span class="cl"><span class="c1">// Let user set their own password via secure link
</span></span></span></code></pre></div><h3 id="fix-5-add-comprehensive-input-validation">Fix #5: Add Comprehensive Input Validation</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">emailValidator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;email-validator&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Validate email format
</span></span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">emailValidator</span><span class="p">.</span><span class="nx">validate</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;Invalid email format&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Validate both raw and normalized lengths
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">rawEmail</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">email</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">normalizedEmail</span> <span class="o">=</span> <span class="nx">normalizeEmail</span><span class="p">(</span><span class="nx">rawEmail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">rawEmail</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span> <span class="nx">normalizedEmail</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;Email address is too long&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr>
<h2 id="lessons-learned">Lessons Learned</h2>
<h3 id="for-developers">For Developers</h3>
<ul>
<li><strong>Understand your crypto primitives:</strong> Know the limitations and behaviors of libraries like bcrypt, including input truncation</li>
<li><strong>Process data consistently:</strong> Apply the same transformations throughout your code when making security decisions</li>
<li><strong>Never trust user input in secrets:</strong> Generated passwords should be purely random without user-controlled components</li>
<li><strong>Validate comprehensively:</strong> Check constraints on data in both raw and processed forms</li>
<li><strong>Complete features before deployment:</strong> Partially implemented security features (like email delivery) often hide vulnerabilities</li>
</ul>
<h3 id="for-security-reviewers">For Security Reviewers</h3>
<ul>
<li><strong>Look for data transformation inconsistencies:</strong> Pay attention to where and how input is processed</li>
<li><strong>Review crypto implementation details:</strong> Don&rsquo;t assume developers understand cryptographic primitives&rsquo; edge cases</li>
<li><strong>Check for user-controlled components:</strong> Secrets should never include user input</li>
<li><strong>Test boundary conditions:</strong> Exploit edge cases like maximum input lengths</li>
<li><strong>Verify defense in depth:</strong> Single points of failure in security controls are warning signs</li>
</ul>
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>This vulnerability demonstrates a crucial principle in application security: vulnerabilities often emerge from the subtle interactions between multiple components rather than obvious coding errors. Each individual piece—bcrypt hashing, email normalization, random password generation—was implemented using industry-standard libraries and best practices. Yet their combination created a critical authentication bypass.</p>
<p>The key takeaway is the importance of understanding not just what your security tools do, but how they behave at their boundaries and how they interact with other components. Bcrypt&rsquo;s 72-byte truncation is well-documented, but it becomes a vulnerability only when combined with user-controlled input in password generation and inconsistent input processing.</p>

</content>



<p>
  
</p>

  </main>
  <footer><footer>
  <p style="text-align: center; margin-bottom: 0.5rem; color: #8f0000 !important;">trying.</p>
</footer></footer>

  
</body>

</html>
